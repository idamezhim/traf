<!DOCTYPE html>
<html lang="en">
@@include('partials/head.html', {"title": "Take 5", "description": "Take a 5 minute breather."})
<body class="animsition">
  @@include('partials/navigation.html')
  <div class="hero breather">
    <div class="main">
      <h1 class="remaining">Take a 5 minute breather and clear your mind.<p>Click anywhere to start.</p></h1>
      <canvas class="timer" width="400" height="400"></canvas>
      <svg class="flower" viewBox="0 0 1000 1000">
        <g class="rose">
          <circle cx="500" cy="500" r="225" style="--angle:300deg;"></circle>
          <circle cx="500" cy="500" r="225" style="--angle:240deg;"></circle>
          <circle cx="500" cy="500" r="225" style="--angle:180deg;"></circle>
          <circle cx="500" cy="500" r="225" style="--angle:120deg;"></circle>
          <circle cx="500" cy="500" r="225" style="--angle:60deg;"></circle>
          <circle cx="500" cy="500" r="225" style="--angle:0deg;"></circle>
        </g>
      </svg>
    </div>
  </div>
  @@include('partials/scripts.html')
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-duration-format/1.3.0/moment-duration-format.min.js"></script>
  <script>
    let main = document.querySelector('.main');
    let display = document.querySelector('.timer');
    let displayCtx = display.getContext('2d');
    let remaining = document.querySelector('.remaining');
    let duration = moment.duration(5, 'minutes');
    let displaySize = display.width;
    main.addEventListener('click', () => {
      if (main.className !== 'waiting') {
        displayTime(moment().add(duration));
      }
    });
    function displayTime(endMoment) {
      var audio = new Audio('sounds/ding.mp3');
      let now = moment();
      if (endMoment.isAfter(now)) {
        let timeLeft = moment.duration(endMoment.diff(now));
        main.className = 'waiting';
        remaining.innerText = timeLeft.format('m:ss', { trim: false });
        clearDisplay();
        renderTrack();
        renderProgress(timeLeft.asMilliseconds() / duration.asMilliseconds());
        requestAnimationFrame(displayTime.bind(this, endMoment));
      } else {
        audio.play();
        audio.volume = 0.2;
        main.className = 'done';
        remaining.innerText = 'Enjoy your day.';
        clearDisplay();
      }
    }
    function clearDisplay() {
      displayCtx.clearRect(0, 0, displaySize, displaySize);
    }
    function renderTrack() {
      displayCtx.strokeStyle = 'hsla(0, 0%, 100%, 0.2)';
      displayCtx.lineWidth = 2;
      displayCtx.beginPath();
      displayCtx.arc(displaySize / 2, displaySize / 2, displaySize * 0.45, 0, Math.PI * 2);
      displayCtx.stroke();
    }
    function renderProgress(amount) {
      displayCtx.strokeStyle = 'hsla(216, 100%, 50%, 1)';
      displayCtx.lineWidth = 2;
      displayCtx.beginPath();
      displayCtx.arc(displaySize / 2, displaySize / 2, displaySize * 0.45, Math.PI * 2 * (1 - amount) - Math.PI / 2, 0 - Math.PI / 2, false);
      displayCtx.stroke();
    }
  </script>
</body>
</html>